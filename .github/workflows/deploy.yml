name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permette di attivare manualmente la workflow

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug - Informazioni evento
        run: |
          echo "üîç Evento che ha attivato la workflow: ${{ github.event_name }}"
          echo "üîç Branch: ${{ github.ref }}"
          echo "üîç Commit: ${{ github.sha }}"
          echo "üîç Autore: ${{ github.actor }}"
      
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check VPS secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå VPS_HOST secret non configurato"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå VPS_USER secret non configurato"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå VPS_SSH_KEY secret non configurato"
            exit 1
          fi
          echo "‚úÖ Tutti i secrets sono configurati"
      
      - name: Deploy to VPS (with automated backups)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          timeout: 1200
          script: |
            # ‚úÖ FIX: Rimosso set -e per permettere al deploy di continuare anche se alcuni step falliscono
            echo "üöÄ Inizio deploy su VPS..."
            
            # Verifica che la directory esista
            if [ ! -d "/var/www/ticketapp" ]; then
              echo "‚ùå Directory /var/www/ticketapp non trovata"
              exit 1
            fi
            
            echo "üõ°Ô∏è Backup automatici (DB + codice) prima del deploy..."
            BACKUP_DIR="/var/backups/ticketapp"
            TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
            sudo mkdir -p "$BACKUP_DIR" || true
            
            # Backup Database PostgreSQL
            if command -v pg_dump &> /dev/null; then
              echo "üì¶ Backup DB Postgres..."
              DB_NAME=${DB_NAME:-ticketapp_db}
              DB_USER=${DB_USER:-postgres}
              DB_HOST=${DB_HOST:-localhost}
              sudo -u "$DB_USER" pg_dump -h "$DB_HOST" "$DB_NAME" -F c -f "$BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.dump" 2>/dev/null || \
                pg_dump -U "$DB_USER" -h "$DB_HOST" "$DB_NAME" -F c -f "$BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.dump" || \
                echo "‚ö†Ô∏è Backup DB non riuscito (continua...)"
            else
              echo "‚ö†Ô∏è pg_dump non disponibile, salto backup DB"
            fi
            
            # Backup codice applicazione
            echo "üì¶ Backup codice applicazione..."
            sudo tar -czf "$BACKUP_DIR/ticketapp_code_${TIMESTAMP}.tar.gz" -C /var/www ticketapp 2>/dev/null || \
              tar -czf "$BACKUP_DIR/ticketapp_code_${TIMESTAMP}.tar.gz" -C /var/www ticketapp || \
              echo "‚ö†Ô∏è Backup codice non riuscito (continua...)"
            
            cd /var/www/ticketapp
            echo "üì• Aggiornamento codice da GitHub..."
            git pull origin main || {
              echo "‚ö†Ô∏è Errore git pull, provo a resettare..."
              git fetch origin
              git reset --hard origin/main
            }
            
            echo "üßπ Pulizia simboli EUR non disponibili su Binance..."
            cd backend
            if [ -f "remove_unavailable_eur_symbols.js" ]; then
              timeout 120 node remove_unavailable_eur_symbols.js || echo "‚ö†Ô∏è Timeout o errore rimozione simboli EUR (continua...)"
            else
              echo "‚ö†Ô∏è Script rimozione simboli EUR non trovato (continua...)"
            fi
            
            echo "üì• Download klines per simboli EUR disponibili..."
            if [ -f "download_eur_klines.js" ]; then
              timeout 300 node download_eur_klines.js || echo "‚ö†Ô∏è Timeout o errore download klines EUR (continua...)"
            else
              echo "‚ö†Ô∏è Script download klines EUR non trovato (continua...)"
            fi
            
            echo "üîß Configurazione simboli EUR nel database..."
            if [ -f "setup_eur_symbols.js" ]; then
              timeout 60 node setup_eur_symbols.js || echo "‚ö†Ô∏è Timeout o errore configurazione simboli EUR (continua...)"
            else
              echo "‚ö†Ô∏è Script configurazione simboli EUR non trovato (continua...)"
            fi
            cd ..
            
            echo "üì¶ Installazione dipendenze backend..."
            cd backend
            timeout 180 npm install --production || timeout 180 npm install || {
              echo "‚ö†Ô∏è Errore installazione dipendenze backend, continua..."
            }
            
            echo "üì¶ Installazione dipendenze frontend..."
            cd ../frontend
            
            echo "üßπ Pulizia cache e build vecchi..."
            # Rimuovi directory build completamente e tutti i file residui
            rm -rf build || true
            rm -rf build/static 2>/dev/null || true
            rm -rf build/*.map 2>/dev/null || true
            
            # Rimuovi cache in modo sicuro (gestisce directory non vuote)
            if [ -d "node_modules/.cache" ]; then
              find node_modules/.cache -mindepth 1 -delete 2>/dev/null || rm -rf node_modules/.cache 2>/dev/null || true
            fi
            
            # Rimuovi anche cache di react-scripts e altri file temporanei
            rm -rf node_modules/.cache/.eslintcache 2>/dev/null || true
            rm -rf .cache 2>/dev/null || true
            rm -rf .eslintcache 2>/dev/null || true
            find . -name "*.map" -type f -delete 2>/dev/null || true
            
            rm -f .env
            rm -f .env.production
            
            echo "üì¶ Reinstallazione dipendenze frontend..."
            timeout 300 npm install || {
              echo "‚ö†Ô∏è Timeout o errore npm install, provo con --legacy-peer-deps..."
              timeout 300 npm install --legacy-peer-deps || {
                echo "‚ùå Errore installazione dipendenze frontend"
                exit 1
              }
            }
            
            echo "üîß Configurazione variabili d'ambiente..."
            # Crea file .env per il build con l'URL corretto del backend
            # Se nginx fa proxy per /api/, usa URL vuoto (chiamate relative)
            # Disabilita source maps per evitare errori durante il build
            echo "REACT_APP_API_URL=" > .env
            echo "GENERATE_SOURCEMAP=false" >> .env
            echo "‚úÖ File .env creato:"
            cat .env
            
            echo "üî® Build frontend (pulito)..."
            # Pulisci eventuali file residui prima del build
            rm -rf build/static 2>/dev/null || true
            timeout 900 npm run build || {
              echo "‚ùå Errore build frontend (timeout o errore)"
              echo "üìã Verifica errori sopra"
              echo "‚ö†Ô∏è Continuo comunque il deploy..."
            }
            
            echo "‚úÖ Verifica build completato..."
            if [ -d "build" ]; then
              echo "‚úÖ Directory build creata correttamente"
              echo "üìä Dimensione build:"
              du -sh build
            else
              echo "‚ùå Directory build non trovata!"
              exit 1
            fi
            
            echo "üîÑ Riavvio servizi..."
            # Prova a riavviare il backend con PM2 (preferito)
            if command -v pm2 &> /dev/null; then
              echo "üîÑ Riavvio backend con PM2..."
              pm2 restart ticketapp-backend 2>/dev/null || \
              pm2 restart all 2>/dev/null || \
              echo "‚ö†Ô∏è PM2 non ha trovato il processo, continua..."
            fi
            
            # Prova anche con systemctl (fallback)
            sudo systemctl restart ticketapp-backend 2>/dev/null || \
            sudo systemctl restart ticketapp 2>/dev/null || \
            sudo systemctl restart node 2>/dev/null || \
            echo "‚ö†Ô∏è Servizio backend systemctl non trovato, continua..."
            
            # Configura nginx
            echo "üîß Configurazione nginx..."
            if [ -f "deploy/nginx/ticketapp.conf" ]; then
              echo "üìã Copia configurazione nginx..."
              sudo cp deploy/nginx/ticketapp.conf /etc/nginx/sites-available/ticketapp.conf
              sudo ln -sf /etc/nginx/sites-available/ticketapp.conf /etc/nginx/sites-enabled/ticketapp.conf
              # Rimuovi default se esiste
              sudo rm -f /etc/nginx/sites-enabled/default
              echo "‚úÖ Configurazione nginx copiata"
            else
              echo "‚ö†Ô∏è File nginx config non trovato, continua..."
            fi
            
            # Test configurazione nginx
            sudo nginx -t || {
              echo "‚ùå Errore configurazione nginx!"
              exit 1
            }
            
            # Riavvia nginx
            sudo systemctl restart nginx || {
              echo "‚ö†Ô∏è Errore riavvio nginx, provo reload..."
              sudo systemctl reload nginx || echo "‚ö†Ô∏è Impossibile riavviare nginx"
            }
            
            echo "‚úÖ Deploy completato!"
            
            # Esegui controllo avvisi e stato sistema
            echo ""
            echo "üîç Esecuzione controllo avvisi e stato sistema..."
            if [ -f "backend/scripts/controlla-avvisi-vps.sh" ]; then
              chmod +x backend/scripts/controlla-avvisi-vps.sh
              timeout 60 bash backend/scripts/controlla-avvisi-vps.sh || echo "‚ö†Ô∏è Timeout o errore durante controllo avvisi (continua...)"
            else
              echo "‚ö†Ô∏è Script controllo avvisi non trovato"
            fi
            
            echo ""
            echo "‚úÖ Deploy completato con successo!"
      - name: Diagnostica VPS (Backend, Nginx, PostgreSQL)
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.VPS_HOST }}
            username: ${{ secrets.VPS_USER }}
            key: ${{ secrets.VPS_SSH_KEY }}
            timeout: 900
            script: |
              echo "üîé Avvio diagnostica VPS..."
              set -x
              # Stato backend (PM2 o systemd)
              pm2 status || sudo systemctl status ticketapp-backend -n 50 --no-pager || true
              pm2 logs --lines 100 || sudo journalctl -u ticketapp-backend -n 100 --no-pager || true
              # Test nginx configurazione e log
              sudo nginx -t || true
              sudo tail -n 100 /var/log/nginx/error.log || true
              sudo tail -n 100 /var/log/nginx/access.log || true
              # Porte in ascolto
              sudo ss -lntp | grep -E "(3001|node)" || true
              # PostgreSQL ping e versione
              psql -U postgres -h localhost -c "SELECT version();" || echo "‚ö†Ô∏è Postgres non raggiungibile"
              # Se variabili di ambiente sono in systemd unit
              sudo systemctl cat ticketapp-backend | sed -n '1,160p' || true
              echo "‚úÖ Diagnostica completata"

